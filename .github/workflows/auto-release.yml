name: Auto Release

on:
  pull_request:
    types: [closed]

permissions:
  contents: write
  packages: read

jobs:
  release:
    if: github.event.pull_request.merged == true && contains(github.event.pull_request.labels.*.name, 'release')
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.base.ref }}
        fetch-depth: 0

    - name: Extract version
      id: version
      run: |
        VERSION=$(grep 'AC_INIT' configure.ac | sed 's/.*\[libfabric\], \[\([^]]*\)\].*/\1/')
        TAG="v$VERSION"
        echo "Extracted version: $VERSION"
        echo "Release tag: $TAG"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=$TAG" >> $GITHUB_OUTPUT

    - name: Build libfabric
      run: |
        set -x
        ./autogen.sh
        ./configure --prefix=$PWD/install
        make
        make install
        make dist

    - name: Build fabtests
      run: |
        set -x
        cd fabtests
        ./autogen.sh
        ./configure --with-libfabric=$PWD/../install
        make dist

    - name: Generate checksums
      id: checksums
      run: |
        echo "sha512_sums<<EOF" >> $GITHUB_OUTPUT
        sha512sum libfabric-*.tar.* fabtests/fabtests-*.tar.* >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        echo "md5_sums<<EOF" >> $GITHUB_OUTPUT
        md5sum libfabric-*.tar.* fabtests/fabtests-*.tar.* >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        name: Libfabric ${{ steps.version.outputs.version }}
        target_commitish: ${{ github.event.pull_request.base.ref }}
        draft: true
        body: |
          The OpenFabrics Interfaces Working Group (OFIWG) and the libfabric open-source community are pleased to announce the release of version ${{ steps.version.outputs.version }} of libfabric. See [NEWS.md](https://github.com/${{ github.repository }}/blob/${{ steps.version.outputs.tag }}/NEWS.md) for the list of features and enhancements that have been added since the last release. Installation instructions are available in the [README.md](https://github.com/${{ github.repository }}/blob/${{ steps.version.outputs.tag }}/README.md) file in the source tree or at the project's homepage.

          Download the distribution tarballs below to get started:

          **sha512 sums**
          ```
          ${{ steps.checksums.outputs.sha512_sums }}
          ```

          **md5sums**
          ```
          ${{ steps.checksums.outputs.md5_sums }}
          ```

          ${{ github.event.pull_request.body }}
        files: |
          libfabric-*.tar.gz
          libfabric-*.tar.bz2
          fabtests/fabtests-*.tar.gz
          fabtests/fabtests-*.tar.bz2